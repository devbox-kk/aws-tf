# Terragrunt Makefile
# AWS S3ç’°å¢ƒã®ç®¡ç†ç”¨

.PHONY: help dev-plan dev-apply dev-apply-auto dev-destroy prod-plan prod-apply prod-apply-auto prod-destroy init clean validate format status dev-workflow

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "Terragrunt S3ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰"
	@echo ""
	@echo "é–‹ç™ºç’°å¢ƒ:"
	@echo "  make dev-plan      - é–‹ç™ºç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make dev-apply     - é–‹ç™ºç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make dev-apply-auto - é–‹ç™ºç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆè‡ªå‹•æ‰¿èªï¼‰"
	@echo "  make dev-destroy   - é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤"
	@echo ""
	@echo "æœ¬ç•ªç’°å¢ƒ:"
	@echo "  make prod-plan     - æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make prod-apply    - æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make prod-apply-auto - æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆè‡ªå‹•æ‰¿èªï¼‰"
	@echo "  make prod-destroy  - æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°:"
	@echo "  target=s3          - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆs3ï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=all         - å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰"
	@echo ""
	@echo "ä½¿ç”¨ä¾‹:"
	@echo "  target=s3 make dev-plan    - S3ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ãƒ—ãƒ©ãƒ³"
	@echo "  target=all make dev-apply  - å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é©ç”¨"
	@echo ""
	@echo "ãã®ä»–:"
	@echo "  make init          - å¿…è¦ãªå‰ææ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯"
	@echo "  make validate      - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼"
	@echo "  make format        - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
	@echo "  make clean         - Terragrunt/Terraformã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"
	@echo "  make status        - å…¨ç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³ã‚’ç¢ºèª"
	@echo "  make setup-state   - Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make dev-workflow  - é–‹ç™ºç’°å¢ƒã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆplanâ†’applyï¼‰"

# å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯
init:
	@echo "=== å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯ ==="
	@command -v aws >/dev/null 2>&1 || { echo "AWS CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@command -v terragrunt >/dev/null 2>&1 || { echo "TerragruntãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@command -v terraform >/dev/null 2>&1 || { echo "TerraformãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@aws sts get-caller-identity >/dev/null 2>&1 || { echo "AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@echo "âœ… å…¨ã¦ã®å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã™"

# Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ
setup-state:
	@echo "=== Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ ==="
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text); \
	aws s3 mb s3://terraform-state-$$ACCOUNT_ID --region ap-northeast-1 2>/dev/null || echo "S3ãƒã‚±ãƒƒãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	aws dynamodb describe-table --table-name terraform-state-lock --region ap-northeast-1 >/dev/null 2>&1 || \
	aws dynamodb create-table \
		--table-name terraform-state-lock \
		--attribute-definitions AttributeName=LockID,AttributeType=S \
		--key-schema AttributeName=LockID,KeyType=HASH \
		--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
		--region ap-northeast-1
	@echo "âœ… ã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã®æº–å‚™å®Œäº†"

# é–‹ç™ºç’°å¢ƒ - ãƒ—ãƒ©ãƒ³
dev-plan: init
	@echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(shell pwd)"
	@echo "environments/devã®å†…å®¹:"
	@ls -la environments/dev/ || echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo "=== Terragrunt plan ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev) ==="
	@export target=$${target:-all}; ./run.sh -e dev -a plan

# é–‹ç™ºç’°å¢ƒ - é©ç”¨
dev-apply: init
	@echo "=== Terragrunt apply ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev) ==="
	@export target=$${target:-all}; ./run.sh -e dev -a apply

# é–‹ç™ºç’°å¢ƒ - é©ç”¨ï¼ˆè‡ªå‹•æ‰¿èªï¼‰
dev-apply-auto: init
	@echo "=== Terragrunt apply ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev, è‡ªå‹•æ‰¿èª) ==="
	@export target=$${target:-all}; ./run.sh -e dev -a apply -y

# é–‹ç™ºç’°å¢ƒ - å‰Šé™¤
dev-destroy: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ./run.sh -e dev -a destroy -y; \
	else \
		echo "âš ï¸  é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ./run.sh -e dev -a destroy -y; \
	fi

# æœ¬ç•ªç’°å¢ƒ - ãƒ—ãƒ©ãƒ³
prod-plan: init
	@echo "=== Terragrunt plan ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: prod) ==="
	@export target=$${target:-all}; ./run.sh -e prod -a plan

# æœ¬ç•ªç’°å¢ƒ - é©ç”¨
prod-apply: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ./run.sh -e prod -a apply; \
	else \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ./run.sh -e prod -a apply; \
	fi

# æœ¬ç•ªç’°å¢ƒ - é©ç”¨ï¼ˆè‡ªå‹•æ‰¿èªï¼‰
prod-apply-auto: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ï¼ˆCIç’°å¢ƒã€è‡ªå‹•æ‰¿èªï¼‰"; \
		export target=$${target:-all}; ./run.sh -e prod -a apply -y; \
	else \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼ˆè‡ªå‹•æ‰¿èªï¼‰"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ./run.sh -e prod -a apply -y; \
	fi

# æœ¬ç•ªç’°å¢ƒ - å‰Šé™¤
prod-destroy: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "ğŸš¨ æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ./run.sh -e prod -a destroy -y; \
	else \
		echo "ğŸš¨ æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "æœ¬å½“ã«ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ./run.sh -e prod -a destroy -y; \
	fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
validate:
	@echo "=== è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ä¸­ ==="
	@find -name "*.hcl" -exec echo "æ¤œè¨¼ä¸­: {}" \; -exec terragrunt hcl format --check {} \; || true
	@find -name "*.tf" -exec echo "æ¤œè¨¼ä¸­: {}" \; -exec terraform fmt -check {} \; || true
	@echo "âœ… æ¤œè¨¼å®Œäº†"

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
format:
	@echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­ ==="
	@find -name "*.hcl" -exec terragrunt hcl format {} \;
	@find -name "*.tf" -exec terraform fmt {} \;
	@echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
clean:
	@echo "=== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­ ==="
	@find -name ".terragrunt-cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@find -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
	@find -name "*.tfstate*" -type f -exec rm -f {} + 2>/dev/null || true
	@find -name ".terraform.lock.hcl" -type f -exec rm -f {} + 2>/dev/null || true
	@echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†"

# å…¨ç’°å¢ƒã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
status:
	@echo "=== ç’°å¢ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª ==="
	@TARGET=$${target:-all}; \
	if [ "$$TARGET" = "all" ]; then \
		echo "é–‹ç™ºç’°å¢ƒ (å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«):"; \
		(cd ./environments/dev && terragrunt state list --terragrunt-non-interactive 2>/dev/null | sed 's/^/  /') || echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—"; \
		echo ""; \
		echo "æœ¬ç•ªç’°å¢ƒ (å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«):"; \
		(cd ./environments/prod && terragrunt state list --terragrunt-non-interactive 2>/dev/null | sed 's/^/  /') || echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—"; \
	else \
		echo "é–‹ç™ºç’°å¢ƒ ($$TARGET ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«):"; \
		(cd "./environments/dev/$$TARGET" && terragrunt state list 2>/dev/null | sed 's/^/  /') || echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—"; \
		echo ""; \
		echo "æœ¬ç•ªç’°å¢ƒ ($$TARGET ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«):"; \
		(cd "./environments/prod/$$TARGET" && terragrunt state list 2>/dev/null | sed 's/^/  /') || echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—"; \
	fi

# é–‹ç™ºç’°å¢ƒã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
dev-workflow: dev-plan
	@echo "é–‹ç™ºç’°å¢ƒã§ã®ãƒ—ãƒ©ãƒ³ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ"
	@read -p "é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] && export target=$${target:-all} && make dev-apply || echo "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
