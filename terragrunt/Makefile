# Terragrunt Makefile
# AWS S3ãŠã‚ˆã³ECRç’°å¢ƒã®ç®¡ç†ç”¨

.PHONY: help dev-plan dev-apply dev-apply-auto dev-destroy prod-plan prod-apply prod-apply-auto prod-destroy init clean validate format status dev-workflow build-dev build-prod build-and-push-dev build-and-push-prod deploy-dev-complete deploy-prod-complete get-alb-url-dev get-alb-url-prod get-cloudfront-url-dev get-cloudfront-url-prod

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "Terragrunt ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰"
	@echo ""
	@echo "é–‹ç™ºç’°å¢ƒ:"
	@echo "  make dev-plan      - é–‹ç™ºç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make dev-apply     - é–‹ç™ºç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make dev-apply-auto - é–‹ç™ºç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆè‡ªå‹•æ‰¿èªï¼‰"
	@echo "  make dev-destroy   - é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤"
	@echo ""
	@echo "æœ¬ç•ªç’°å¢ƒ:"
	@echo "  make prod-plan     - æœ¬ç•ªç’°å¢ƒã®ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º"
	@echo "  make prod-apply    - æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make prod-apply-auto - æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆè‡ªå‹•æ‰¿èªï¼‰"
	@echo "  make prod-destroy  - æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤"
	@echo ""
	@echo "Docker & ECR:"
	@echo "  make build-dev     - é–‹ç™ºç’°å¢ƒç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make build-prod    - æœ¬ç•ªç’°å¢ƒç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make build-and-push-dev  - é–‹ç™ºç’°å¢ƒã«ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥"
	@echo "  make build-and-push-prod - æœ¬ç•ªç’°å¢ƒã«ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥"
	@echo ""
	@echo "å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ (VPC + ECR + ECS Fargate):"
	@echo "  make deploy-dev-complete  - é–‹ç™ºç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make deploy-prod-complete - æœ¬ç•ªç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make deploy-infra-dev     - é–‹ç™ºç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make deploy-infra-prod    - æœ¬ç•ªç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo ""
	@echo "ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±:"
	@echo "  make get-alb-url-dev      - é–‹ç™ºç’°å¢ƒã®ALB URLã‚’å–å¾—"
	@echo "  make get-alb-url-prod     - æœ¬ç•ªç’°å¢ƒã®ALB URLã‚’å–å¾—"
	@echo "  make get-cloudfront-url-dev  - é–‹ç™ºç’°å¢ƒã®CloudFront URLã‚’å–å¾—"
	@echo "  make get-cloudfront-url-prod - æœ¬ç•ªç’°å¢ƒã®CloudFront URLã‚’å–å¾—"
	@echo ""
	@echo "ç’°å¢ƒå¤‰æ•°:"
	@echo "  target=source      - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆECRã€S3ï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=iam         - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆIAMï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=network     - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆVPCã€SGã€LBï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=log         - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆCloudWatchï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=servise_staticweb  - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆCloudFrontã€Cognitoï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=servise_dynamicweb - ç‰¹å®šã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆECSï¼‰ã®ã¿å®Ÿè¡Œ"
	@echo "  target=all         - å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰"
	@echo "  IMAGE_TAG=v1.0.0   - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¿ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: latestï¼‰"
	@echo ""
	@echo "ä½¿ç”¨ä¾‹:"
	@echo "  target=source make dev-plan      - ã‚½ãƒ¼ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆECRã€S3ï¼‰ã®ã¿ãƒ—ãƒ©ãƒ³"
	@echo "  target=iam make dev-apply        - IAMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿é©ç”¨"
	@echo "  target=network make dev-apply    - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆVPCã€SGã€LBï¼‰ã®ã¿é©ç”¨"
	@echo "  target=log make dev-apply        - ãƒ­ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆCloudWatchï¼‰ã®ã¿é©ç”¨"
	@echo "  target=servise_staticweb make dev-apply  - é™çš„Webã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿é©ç”¨"
	@echo "  target=servise_dynamicweb make dev-apply - å‹•çš„Webã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆECSï¼‰ã®ã¿é©ç”¨"
	@echo "  IMAGE_TAG=v1.0.0 make build-and-push-dev - ç‰¹å®šã‚¿ã‚°ã§ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥"
	@echo ""
	@echo "ãã®ä»–:"
	@echo "  make init          - å¿…è¦ãªå‰ææ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯"
	@echo "  make validate      - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼"
	@echo "  make format        - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
	@echo "  make clean         - Terragrunt/Terraformã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢"
	@echo "  make status        - å…¨ç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³ã‚’ç¢ºèª"
	@echo "  make setup-state   - Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ"
	@echo "  make dev-workflow  - é–‹ç™ºç’°å¢ƒã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆplanâ†’applyï¼‰"
	@echo ""
	@echo "æ³¨æ„:"
	@echo "  - å¾“æ¥ã®Docker builderã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆBuildKitç„¡åŠ¹ï¼‰"
	@echo "  - Dockerãƒãƒ¼ã‚¸ãƒ§ãƒ³ 20.10+ ã‚’æ¨å¥¨ã—ã¾ã™"
	@echo "  - BuildKitã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ docker buildx ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"

# å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯
init:
	@echo "=== å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯ ==="
	@command -v aws >/dev/null 2>&1 || { echo "AWS CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@command -v terragrunt >/dev/null 2>&1 || { echo "TerragruntãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@command -v terraform >/dev/null 2>&1 || { echo "TerraformãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@command -v docker >/dev/null 2>&1 || { echo "DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@aws sts get-caller-identity >/dev/null 2>&1 || { echo "AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"; exit 1; }
	@echo "Docker BuildKit: disabled (legacy builder)"
	@echo "âœ… å…¨ã¦ã®å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã™"

# Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ
setup-state:
	@echo "=== Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ ==="
	@ACCOUNT_ID=$$(aws sts get-caller-identity --query Account --output text); \
	aws s3 mb s3://terraform-state-$$ACCOUNT_ID --region ap-northeast-1 2>/dev/null || echo "S3ãƒã‚±ãƒƒãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	aws dynamodb describe-table --table-name terraform-state-lock --region ap-northeast-1 >/dev/null 2>&1 || \
	aws dynamodb create-table \
		--table-name terraform-state-lock \
		--attribute-definitions AttributeName=LockID,AttributeType=S \
		--key-schema AttributeName=LockID,KeyType=HASH \
		--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
		--region ap-northeast-1
	@echo "âœ… ã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã®æº–å‚™å®Œäº†"

# é–‹ç™ºç’°å¢ƒ - ãƒ—ãƒ©ãƒ³
dev-plan: init
	@echo "=== Terragrunt plan ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev) ==="
	@export target=$${target:-all}; ../scripts/terragrunt_run.sh -e dev -a plan

# é–‹ç™ºç’°å¢ƒ - é©ç”¨
dev-apply: init
	@echo "=== Terragrunt apply ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev) ==="
	@export target=$${target:-all}; ../scripts/terragrunt_run.sh -e dev -a apply

# é–‹ç™ºç’°å¢ƒ - é©ç”¨ï¼ˆè‡ªå‹•æ‰¿èªï¼‰
dev-apply-auto: init
	@echo "=== Terragrunt apply ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: dev, è‡ªå‹•æ‰¿èª) ==="
	@export target=$${target:-all}; ../scripts/terragrunt_run.sh -e dev -a apply -y

# é–‹ç™ºç’°å¢ƒ - å‰Šé™¤
dev-destroy: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e dev -a destroy -y; \
	else \
		echo "âš ï¸  é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e dev -a destroy -y; \
	fi

# æœ¬ç•ªç’°å¢ƒ - ãƒ—ãƒ©ãƒ³
prod-plan: init
	@echo "=== Terragrunt plan ã‚’å®Ÿè¡Œä¸­ (ç’°å¢ƒ: prod) ==="
	@export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a plan

# æœ¬ç•ªç’°å¢ƒ - é©ç”¨
prod-apply: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a apply; \
	else \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a apply; \
	fi

# æœ¬ç•ªç’°å¢ƒ - é©ç”¨ï¼ˆè‡ªå‹•æ‰¿èªï¼‰
prod-apply-auto: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆä¸­ï¼ˆCIç’°å¢ƒã€è‡ªå‹•æ‰¿èªï¼‰"; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a apply -y; \
	else \
		echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼ˆè‡ªå‹•æ‰¿èªï¼‰"; \
		read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a apply -y; \
	fi

# æœ¬ç•ªç’°å¢ƒ - å‰Šé™¤
prod-destroy: init
	@if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
		echo "ğŸš¨ æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ï¼ˆCIç’°å¢ƒï¼‰"; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a destroy -y; \
	else \
		echo "ğŸš¨ æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"; \
		read -p "æœ¬å½“ã«ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }; \
		export target=$${target:-all}; ../scripts/terragrunt_run.sh -e prod -a destroy -y; \
	fi

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
validate:
	@echo "=== è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ä¸­ ==="
	@find -name "*.hcl" -exec echo "æ¤œè¨¼ä¸­: {}" \; -exec terragrunt hcl format --check {} \; || true
	@find -name "*.tf" -exec echo "æ¤œè¨¼ä¸­: {}" \; -exec terraform fmt -check {} \; || true
	@echo "âœ… æ¤œè¨¼å®Œäº†"

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
format:
	@echo "=== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­ ==="
	@find -name "*.hcl" -exec terragrunt hcl format {} \;
	@find -name "*.tf" -exec terraform fmt {} \;
	@echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
clean:
	@echo "=== ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ä¸­ ==="
	@find -name ".terragrunt-cache" -type d -exec rm -rf {} + 2>/dev/null || true
	@find -name ".terraform" -type d -exec rm -rf {} + 2>/dev/null || true
	@find -name "*.tfstate*" -type f -exec rm -f {} + 2>/dev/null || true
	@find -name ".terraform.lock.hcl" -type f -exec rm -f {} + 2>/dev/null || true
	@echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å®Œäº†"

# å…¨ç’°å¢ƒã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
status:
	@echo "=== ç’°å¢ƒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª ==="
	@echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $$(pwd)"
	@echo "environments/devã®å†…å®¹:"
	@ls -la ./environments/dev || echo "é–‹ç™ºç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
	@echo ""
	@TARGET=$${target:-all}; \
	if [ "$$TARGET" = "all" ]; then \
		echo "=== é–‹ç™ºç’°å¢ƒ (å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) ==="; \
		if [ -d "./environments/dev" ]; then \
			echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ./environments/dev"; \
			cd ./environments/dev && \
			( \
				STATE_OUTPUT=$$(terragrunt state list --terragrunt-non-interactive 2>&1); \
				STATE_EXIT_CODE=$$?; \
				if [ $$STATE_EXIT_CODE -eq 0 ] && echo "$$STATE_OUTPUT" | grep -q .; then \
					echo "ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§:"; \
					echo "$$STATE_OUTPUT" | sed 's/^/  /'; \
				else \
					if [ $$STATE_EXIT_CODE -ne 0 ]; then \
						echo "  åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (exit code: $$STATE_EXIT_CODE)"; \
						if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
							echo "  ã‚¨ãƒ©ãƒ¼è©³ç´°: $$STATE_OUTPUT"; \
						fi; \
					else \
						echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—ã€ã¾ãŸã¯åˆæœŸåŒ–ãŒå¿…è¦"; \
					fi; \
				fi; \
			); \
		else \
			echo "  é–‹ç™ºç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
		fi; \
		echo ""; \
		echo "=== æœ¬ç•ªç’°å¢ƒ (å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) ==="; \
		if [ -d "./environments/prod" ]; then \
			echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ./environments/prod"; \
			cd ./environments/prod && \
			( \
				STATE_OUTPUT=$$(terragrunt state list --terragrunt-non-interactive 2>&1); \
				STATE_EXIT_CODE=$$?; \
				if [ $$STATE_EXIT_CODE -eq 0 ] && echo "$$STATE_OUTPUT" | grep -q .; then \
					echo "ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§:"; \
					echo "$$STATE_OUTPUT" | sed 's/^/  /'; \
				else \
					if [ $$STATE_EXIT_CODE -ne 0 ]; then \
						echo "  åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (exit code: $$STATE_EXIT_CODE)"; \
						if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
							echo "  ã‚¨ãƒ©ãƒ¼è©³ç´°: $$STATE_OUTPUT"; \
						fi; \
					else \
						echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—ã€ã¾ãŸã¯åˆæœŸåŒ–ãŒå¿…è¦"; \
					fi; \
				fi; \
			); \
		else \
			echo "  æœ¬ç•ªç’°å¢ƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
		fi; \
	else \
		echo "=== é–‹ç™ºç’°å¢ƒ ($$TARGET ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) ==="; \
		if [ -d "./environments/dev/$$TARGET" ]; then \
			echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ./environments/dev/$$TARGET"; \
			cd "./environments/dev/$$TARGET" && \
			( \
				STATE_OUTPUT=$$(terragrunt state list --terragrunt-non-interactive 2>&1); \
				STATE_EXIT_CODE=$$?; \
				if [ $$STATE_EXIT_CODE -eq 0 ] && echo "$$STATE_OUTPUT" | grep -q .; then \
					echo "ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§:"; \
					echo "$$STATE_OUTPUT" | sed 's/^/  /'; \
				else \
					if [ $$STATE_EXIT_CODE -ne 0 ]; then \
						echo "  åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (exit code: $$STATE_EXIT_CODE)"; \
						if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
							echo "  ã‚¨ãƒ©ãƒ¼è©³ç´°: $$STATE_OUTPUT"; \
						fi; \
					else \
						echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—ã€ã¾ãŸã¯åˆæœŸåŒ–ãŒå¿…è¦"; \
					fi; \
				fi; \
			); \
		else \
			echo "  ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: ./environments/dev/$$TARGET"; \
		fi; \
		echo ""; \
		echo "=== æœ¬ç•ªç’°å¢ƒ ($$TARGET ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«) ==="; \
		if [ -d "./environments/prod/$$TARGET" ]; then \
			echo "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ./environments/prod/$$TARGET"; \
			cd "./environments/prod/$$TARGET" && \
			( \
				STATE_OUTPUT=$$(terragrunt state list --terragrunt-non-interactive 2>&1); \
				STATE_EXIT_CODE=$$?; \
				if [ $$STATE_EXIT_CODE -eq 0 ] && echo "$$STATE_OUTPUT" | grep -q .; then \
					echo "ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§:"; \
					echo "$$STATE_OUTPUT" | sed 's/^/  /'; \
				else \
				 if [ $$STATE_EXIT_CODE -ne 0 ]; then \
						echo "  åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ (exit code: $$STATE_EXIT_CODE)"; \
						if [ "$$CI" = "true" ] || [ "$$GITHUB_ACTIONS" = "true" ]; then \
							echo "  ã‚¨ãƒ©ãƒ¼è©³ç´°: $$STATE_OUTPUT"; \
						fi; \
					else \
						echo "  ãƒªã‚½ãƒ¼ã‚¹ãªã—ã€ã¾ãŸã¯åˆæœŸåŒ–ãŒå¿…è¦"; \
					fi; \
				fi; \
			); \
		else \
			echo "  ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: ./environments/prod/$$TARGET"; \
		fi; \
	fi

# é–‹ç™ºç’°å¢ƒã§ã®å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
dev-workflow: dev-plan
	@echo "é–‹ç™ºç’°å¢ƒã§ã®ãƒ—ãƒ©ãƒ³ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ"
	@read -p "é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] && export target=$${target:-all} && make dev-apply || echo "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"

# Docker & ECR ã‚³ãƒãƒ³ãƒ‰
build-dev:
	@echo "=== é–‹ç™ºç’°å¢ƒç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­ ==="
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; \
	DOCKER_BUILDKIT=0 docker build -t helloworld-dev:$$IMAGE_TAG ../docker/helloworld
	@echo "âœ… é–‹ç™ºç’°å¢ƒç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-prod:
	@echo "=== æœ¬ç•ªç’°å¢ƒç”¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­ ==="
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; \
	DOCKER_BUILDKIT=0 docker build -t helloworld-prod:$$IMAGE_TAG ../docker/helloworld
	@echo "âœ… æœ¬ç•ªç’°å¢ƒç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Œäº†"

build-and-push-dev: init
	@echo "=== é–‹ç™ºç’°å¢ƒã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ä¸­ ==="
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; \
	../scripts/build-and-push.sh dev $$IMAGE_TAG
	@echo "âœ… é–‹ç™ºç’°å¢ƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

build-and-push-prod: init
	@echo "=== æœ¬ç•ªç’°å¢ƒã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥ä¸­ ==="
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; \
	../scripts/build-and-push.sh prod $$IMAGE_TAG
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

# ECRãƒªãƒã‚¸ãƒˆãƒªä½œæˆ + Dockerãƒ—ãƒƒã‚·ãƒ¥ + ECS Fargateã®å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
deploy-dev-complete: 
	@echo "=== é–‹ç™ºç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ==="
	@echo "1. ã‚½ãƒ¼ã‚¹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆECRã€S3ï¼‰ä½œæˆ..."
	@export target=source; make dev-apply-auto
	@echo "2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥..."
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; make build-and-push-dev
	@echo "3. ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤..."
	@make dev-apply-auto
	@echo "âœ… é–‹ç™ºç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
	@echo "ğŸŒ é–‹ç™ºç’°å¢ƒã®HelloWorldã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URLã‚’å–å¾—ä¸­..."
	@make get-alb-url-dev

deploy-prod-complete:
	@echo "=== æœ¬ç•ªç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ==="
	@echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }
	@echo "1. ã‚½ãƒ¼ã‚¹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆECRã€S3ï¼‰ä½œæˆ..."
	@export target=source; make prod-apply-auto
	@echo "2. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰&ãƒ—ãƒƒã‚·ãƒ¥..."
	@IMAGE_TAG=$${IMAGE_TAG:-latest}; make build-and-push-prod
	@echo "3. ä»–ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤..."
	@make prod-apply-auto
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ã‚¤ãƒ³ãƒ•ãƒ©ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVPC + ECR + ECSã€Dockerãƒ—ãƒƒã‚·ãƒ¥ãªã—ï¼‰
deploy-infra-dev:
	@echo "=== é–‹ç™ºç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ ==="
	@echo "1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ï¼ˆVPCã€SGã€LBï¼‰ä½œæˆ..."
	@export target=network; make dev-apply-auto
	@echo "2. ã‚½ãƒ¼ã‚¹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆECRã€S3ï¼‰ä½œæˆ..."
	@export target=source; make dev-apply-auto
	@echo "3. å‹•çš„Webã‚µãƒ¼ãƒ“ã‚¹ï¼ˆECSï¼‰ä½œæˆ..."
	@export target=servise_dynamicweb; make dev-apply-auto
	@echo "âœ… é–‹ç™ºç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

deploy-infra-prod:
	@echo "=== æœ¬ç•ªç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤ ==="
	@echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): " confirm && [ "$$confirm" = "y" ] || { echo "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; exit 1; }
	@echo "1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ï¼ˆVPCã€SGã€LBï¼‰ä½œæˆ..."
	@export target=network; make prod-apply-auto
	@echo "2. ã‚½ãƒ¼ã‚¹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆECRã€S3ï¼‰ä½œæˆ..."
	@export target=source; make prod-apply-auto
	@echo "3. å‹•çš„Webã‚µãƒ¼ãƒ“ã‚¹ï¼ˆECSï¼‰ä½œæˆ..."
	@export target=servise_dynamicweb; make prod-apply-auto
	@echo "âœ… æœ¬ç•ªç’°å¢ƒã®ã‚¤ãƒ³ãƒ•ãƒ©ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ALB URLå–å¾—ã‚³ãƒãƒ³ãƒ‰
get-alb-url-dev:
	@echo "=== é–‹ç™ºç’°å¢ƒã®ALB URLå–å¾— ==="
	@cd ./environments/dev/network && \
	ALB_DNS=$$(terragrunt output -raw load_balancer_dns_name 2>/dev/null); \
	if [ -n "$$ALB_DNS" ] && [ "$$ALB_DNS" != "null" ]; then \
		echo "ğŸŒ é–‹ç™ºç’°å¢ƒã®HelloWorldã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URL:"; \
		echo "   http://$$ALB_DNS"; \
		echo ""; \
		echo "ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:"; \
		echo "   curl http://$$ALB_DNS"; \
		echo "   ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"; \
	else \
		echo "âŒ ALBãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšALBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„:"; \
		echo "   make deploy-infra-dev"; \
	fi

get-alb-url-prod:
	@echo "=== æœ¬ç•ªç’°å¢ƒã®ALB URLå–å¾— ==="
	@cd ./environments/prod/network && \
	ALB_DNS=$$(terragrunt output -raw load_balancer_dns_name 2>/dev/null); \
	if [ -n "$$ALB_DNS" ] && [ "$$ALB_DNS" != "null" ]; then \
		echo "ğŸŒ æœ¬ç•ªç’°å¢ƒã®HelloWorldã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URL:"; \
		echo "   http://$$ALB_DNS"; \
		echo ""; \
		echo "ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:"; \
		echo "   curl http://$$ALB_DNS"; \
		echo "   ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"; \
	else \
		echo "âŒ ALBãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšALBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„:"; \
		echo "   make deploy-infra-prod"; \
	fi

# CloudFront URLå–å¾—ã‚³ãƒãƒ³ãƒ‰
get-cloudfront-url-dev:
	@echo "=== é–‹ç™ºç’°å¢ƒã®CloudFront URLå–å¾— ==="
	@cd ./environments/dev/servise_staticweb && \
	CLOUDFRONT_URL=$$(terragrunt output -raw cloudfront_url 2>/dev/null); \
	if [ -n "$$CLOUDFRONT_URL" ] && [ "$$CLOUDFRONT_URL" != "null" ]; then \
		echo "ğŸŒ é–‹ç™ºç’°å¢ƒã®é™çš„Webã‚µã‚¤ãƒˆURL:"; \
		echo "   $$CLOUDFRONT_URL"; \
		echo ""; \
		echo "ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:"; \
		echo "   curl $$CLOUDFRONT_URL"; \
		echo "   ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"; \
		echo ""; \
		DOMAIN_NAME=$$(terragrunt output -raw cloudfront_domain_name 2>/dev/null); \
		if [ -n "$$DOMAIN_NAME" ]; then \
			echo "ğŸ“ CloudFrontãƒ‰ãƒ¡ã‚¤ãƒ³å: $$DOMAIN_NAME"; \
		fi; \
	else \
		echo "âŒ CloudFrontãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšCloudFrontã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„:"; \
		echo "   target=servise_staticweb make dev-apply"; \
	fi

get-cloudfront-url-prod:
	@echo "=== æœ¬ç•ªç’°å¢ƒã®CloudFront URLå–å¾— ==="
	@cd ./environments/prod/servise_staticweb && \
	CLOUDFRONT_URL=$$(terragrunt output -raw cloudfront_url 2>/dev/null); \
	if [ -n "$$CLOUDFRONT_URL" ] && [ "$$CLOUDFRONT_URL" != "null" ]; then \
		echo "ğŸŒ æœ¬ç•ªç’°å¢ƒã®é™çš„Webã‚µã‚¤ãƒˆURL:"; \
		echo "   $$CLOUDFRONT_URL"; \
		echo ""; \
		echo "ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:"; \
		echo "   curl $$CLOUDFRONT_URL"; \
		echo "   ã¾ãŸã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¸Šè¨˜URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„"; \
		echo ""; \
		DOMAIN_NAME=$$(terragrunt output -raw cloudfront_domain_name 2>/dev/null); \
		if [ -n "$$DOMAIN_NAME" ]; then \
			echo "ğŸ“ CloudFrontãƒ‰ãƒ¡ã‚¤ãƒ³å: $$DOMAIN_NAME"; \
		fi; \
	else \
		echo "âŒ CloudFrontãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãšCloudFrontã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„:"; \
		echo "   target=servise_staticweb make prod-apply"; \
	fi
