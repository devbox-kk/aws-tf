name: Terragrunt CI/CD

on:
  # æ‰‹å‹•å®Ÿè¡Œï¼ˆplan, apply, destroyï¼‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Terragrunt action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy
      target:
        description: 'Target module (optional)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - s3
      auto_approve:
        description: 'Auto approve for apply/destroy'
        required: false
        default: false
        type: boolean

  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯è‡ªå‹•ã§planå®Ÿè¡Œ
  pull_request:
    branches: [main, master]
    paths:
      - 'terragrunt/**'

  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã¯devç’°å¢ƒã§planå®Ÿè¡Œ
  push:
    branches: [main, master]
    paths:
      - 'terragrunt/**'

  # æ¯æ—¥18æ™‚ã«devç’°å¢ƒã®destroyå®Ÿè¡Œ
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 (JST 03:00)

env:
  AWS_DEFAULT_REGION: ap-northeast-1
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  terragrunt:
    name: Terragrunt ${{ github.event.inputs.action || 'plan' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terragrunt

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify workspace structure
      run: |
        echo "=== ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ§‹é€ ç¢ºèª ==="
        echo "Root directory:"
        ls -la
        echo ""
        echo "Terragrunt directory:"
        cd terragrunt && ls -la
        echo ""
        echo "Environments:"
        ls -la terragrunt/environments/ || echo "environments not found"
        echo ""
        echo "Dev environment:"
        ls -la terragrunt/environments/dev/ || echo "dev not found"
        echo ""
        echo "Prod environment:"
        ls -la terragrunt/environments/prod/ || echo "prod not found"
      working-directory: .

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.6.0

    - name: Setup Terragrunt
      run: |
        wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.82.3/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
        terragrunt --version

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Verify AWS credentials
      run: |
        echo "Testing AWS credentials..."
        aws sts get-caller-identity
        aws s3 ls || echo "No S3 access or no buckets"

    - name: Initialize Terragrunt
      run: |
        echo "=== åˆæœŸåŒ–å‰ã®çŠ¶æ…‹ç¢ºèª ==="
        ls -la
        ls -la environments/ || echo "environments/ not found"
        echo ""
        echo "=== åˆæœŸåŒ–å®Ÿè¡Œ ==="
        make init

    - name: Setup state resources
      run: make setup-state
      if: github.event.inputs.action != 'destroy' && github.event_name != 'schedule'

    - name: Validate configuration
      run: make validate
      if: github.event.inputs.action == 'plan' || github.event_name == 'pull_request' || github.event_name == 'push'

    - name: Format check
      run: |
        make format
        if [ -n "$(git status --porcelain)" ]; then
          echo "Files were formatted. Please commit the changes."
          git diff
          exit 1
        fi
      if: github.event_name == 'pull_request'

    # Planå®Ÿè¡Œ
    - name: Terragrunt Plan (Dev)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        make dev-plan
      if: |
        (github.event.inputs.action == 'plan' && github.event.inputs.environment == 'dev') ||
        github.event_name == 'pull_request' ||
        github.event_name == 'push'

    - name: Terragrunt Plan (Prod)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        make prod-plan
      if: github.event.inputs.action == 'plan' && github.event.inputs.environment == 'prod'

    # Applyå®Ÿè¡Œ
    - name: Terragrunt Apply (Dev)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
          make dev-apply-auto
        else
          make dev-apply
        fi
      if: github.event.inputs.action == 'apply' && github.event.inputs.environment == 'dev'

    - name: Terragrunt Apply (Prod)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        if [ "${{ github.event.inputs.auto_approve }}" = "true" ]; then
          make prod-apply-auto
        else
          make prod-apply
        fi
      if: github.event.inputs.action == 'apply' && github.event.inputs.environment == 'prod'

    # Destroyå®Ÿè¡Œ
    - name: Terragrunt Destroy (Dev)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        make dev-destroy
      if: github.event.inputs.action == 'destroy' && github.event.inputs.environment == 'dev'

    - name: Terragrunt Destroy (Prod)
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        make prod-destroy
      if: github.event.inputs.action == 'destroy' && github.event.inputs.environment == 'prod'

    - name: Show status
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        echo "=== ãƒ‡ãƒãƒƒã‚°æƒ…å ± ==="
        echo "Working directory: $(pwd)"
        echo "Available directories:"
        ls -la environments/ || echo "environments/ not found"
        echo "Target: $target"
        echo "CI: $CI"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        echo ""
        echo "=== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå®Ÿè¡Œ ==="
        make status
      if: always()

    - name: Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const output = `#### Terragrunt Plan ğŸ—ºï¸
          **Environment:** dev
          **Target:** ${{ github.event.inputs.target || 'all' }}
          **Triggered by:** ${{ github.event_name }}
          
          <details><summary>Show Plan Details</summary>
          
          Planå®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ã¯Actionsãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          
          </details>
          
          *Pusher: @${{ github.actor }}*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # å®šæœŸå®Ÿè¡Œç”¨ã®åˆ¥ã‚¸ãƒ§ãƒ–
  scheduled-destroy:
    name: Scheduled Destroy (Dev)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    defaults:
      run:
        working-directory: terragrunt

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify workspace structure (scheduled)
      run: |
        echo "=== ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ§‹é€ ç¢ºèªï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰ ==="
        echo "Root directory:"
        ls -la
        echo ""
        echo "Terragrunt directory:"
        cd terragrunt && ls -la
        echo ""
        echo "Environments:"
        ls -la terragrunt/environments/ || echo "environments not found"
      working-directory: .

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.6.0

    - name: Setup Terragrunt
      run: |
        wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.82.3/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
        terragrunt --version

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1

    - name: Initialize Terragrunt
      run: |
        echo "=== åˆæœŸåŒ–å‰ã®çŠ¶æ…‹ç¢ºèªï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰ ==="
        ls -la
        ls -la environments/ || echo "environments/ not found"
        echo ""
        echo "=== åˆæœŸåŒ–å®Ÿè¡Œ ==="
        make init

    - name: Check resources before destroy
      run: |
        export target=all
        echo "=== å‰Šé™¤å‰ã®ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="
        echo "Available environments:"
        ls -la environments/ || echo "environments/ not found"
        make status

    - name: Destroy dev environment
      run: |
        export target=all
        echo "=== Devç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ ==="
        make dev-destroy

    - name: Verify destruction
      run: |
        export target=all
        echo "=== å‰Šé™¤å¾Œã®ç¢ºèª ==="
        make status
