name: AWS Credentials Test

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      detailed_check:
        description: 'Perform detailed AWS permissions check'
        required: false
        default: true
        type: boolean

env:
  AWS_DEFAULT_REGION: ap-northeast-1

jobs:
  test-credentials:
    name: Test AWS Credentials
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Check if secrets exist
      run: |
        echo "=== GitHub Secrets Verification ==="
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
          echo "âŒ AWS_ACCESS_KEY_ID secret is NOT set"
          echo "::error::AWS_ACCESS_KEY_ID secret is missing"
          exit 1
        else
          echo "âœ… AWS_ACCESS_KEY_ID secret is set"
          echo "   Value starts with: $(echo '${{ secrets.AWS_ACCESS_KEY_ID }}' | cut -c1-4)..."
        fi
        
        if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "âŒ AWS_SECRET_ACCESS_KEY secret is NOT set"
          echo "::error::AWS_SECRET_ACCESS_KEY secret is missing"
          exit 1
        else
          echo "âœ… AWS_SECRET_ACCESS_KEY secret is set"
          echo "   Length: $(echo '${{ secrets.AWS_SECRET_ACCESS_KEY }}' | wc -c) characters"
        fi

    - name: Test basic AWS authentication
      run: |
        echo "=== Basic AWS Authentication Test ==="
        echo "Testing STS GetCallerIdentity..."
        
        if aws sts get-caller-identity; then
          echo "âœ… AWS authentication successful"
          
          # ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          USER_ARN=$(aws sts get-caller-identity --query Arn --output text)
          USER_ID=$(aws sts get-caller-identity --query UserId --output text)
          
          echo ""
          echo "ğŸ“‹ Account Information:"
          echo "   Account ID: $ACCOUNT_ID"
          echo "   User ARN: $USER_ARN"
          echo "   User ID: $USER_ID"
        else
          echo "âŒ AWS authentication failed"
          echo "::error::Cannot authenticate to AWS with provided credentials"
          exit 1
        fi

    - name: Test S3 permissions
      run: |
        echo "=== S3 Permissions Test ==="
        
        # S3ãƒã‚±ãƒƒãƒˆä¸€è¦§ã®å–å¾—ãƒ†ã‚¹ãƒˆ
        echo "Testing S3 ListBuckets permission..."
        if aws s3 ls > /dev/null 2>&1; then
          echo "âœ… S3 ListBuckets permission: OK"
          
          # æ—¢å­˜ãƒã‚±ãƒƒãƒˆã®è¡¨ç¤º
          BUCKET_COUNT=$(aws s3 ls | wc -l)
          echo "   Found $BUCKET_COUNT existing buckets"
          
          if [ $BUCKET_COUNT -gt 0 ]; then
            echo "   Existing buckets:"
            aws s3 ls | head -5 | sed 's/^/     /'
            if [ $BUCKET_COUNT -gt 5 ]; then
              echo "     ... and $((BUCKET_COUNT - 5)) more"
            fi
          fi
        else
          echo "âš ï¸  S3 ListBuckets permission: Limited or denied"
        fi
        
        # Terraformã‚¹ãƒ†ãƒ¼ãƒˆç”¨ãƒã‚±ãƒƒãƒˆã®ç¢ºèª
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        STATE_BUCKET="terraform-state-$ACCOUNT_ID"
        
        echo ""
        echo "Testing Terraform state bucket access..."
        echo "   Checking bucket: $STATE_BUCKET"
        
        if aws s3 ls "s3://$STATE_BUCKET" > /dev/null 2>&1; then
          echo "âœ… Terraform state bucket access: OK"
          echo "   Bucket exists and is accessible"
        else
          echo "â„¹ï¸  Terraform state bucket: Not found (will be created when needed)"
        fi

    - name: Test DynamoDB permissions
      run: |
        echo "=== DynamoDB Permissions Test ==="
        
        # DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã®å–å¾—ãƒ†ã‚¹ãƒˆ
        echo "Testing DynamoDB ListTables permission..."
        if aws dynamodb list-tables --region $AWS_DEFAULT_REGION > /dev/null 2>&1; then
          echo "âœ… DynamoDB ListTables permission: OK"
          
          # æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
          TABLE_COUNT=$(aws dynamodb list-tables --region $AWS_DEFAULT_REGION --query 'length(TableNames)' --output text)
          echo "   Found $TABLE_COUNT existing tables"
          
          if [ $TABLE_COUNT -gt 0 ]; then
            echo "   Existing tables:"
            aws dynamodb list-tables --region $AWS_DEFAULT_REGION --query 'TableNames' --output text | tr '\t' '\n' | head -5 | sed 's/^/     /'
          fi
        else
          echo "âš ï¸  DynamoDB ListTables permission: Limited or denied"
        fi
        
        # Terraformãƒ­ãƒƒã‚¯ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
        echo ""
        echo "Testing Terraform lock table access..."
        echo "   Checking table: terraform-state-lock"
        
        if aws dynamodb describe-table --table-name terraform-state-lock --region $AWS_DEFAULT_REGION > /dev/null 2>&1; then
          echo "âœ… Terraform lock table access: OK"
          echo "   Table exists and is accessible"
        else
          echo "â„¹ï¸  Terraform lock table: Not found (will be created when needed)"
        fi

    - name: Test IAM permissions (detailed)
      if: github.event.inputs.detailed_check == 'true'
      run: |
        echo "=== Detailed IAM Permissions Test ==="
        
        # ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
        echo "Current user/role information:"
        aws sts get-caller-identity --query '{Account:Account,Arn:Arn,UserId:UserId}' --output table
        
        echo ""
        echo "Testing specific permissions required for Terraform..."
        
        # S3æ¨©é™ã®ãƒ†ã‚¹ãƒˆ
        echo ""
        echo "ğŸ” S3 Permissions:"
        
        # CreateBucketæ¨©é™ã®ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿéš›ã«ã¯ä½œæˆã—ãªã„ï¼‰
        TEST_BUCKET_NAME="terraform-test-$(date +%s)-deleteme"
        echo "   Testing S3 CreateBucket permission..."
        
        if aws s3 mb "s3://$TEST_BUCKET_NAME" --region $AWS_DEFAULT_REGION 2>/dev/null; then
          echo "   âœ… S3 CreateBucket: OK"
          # ãƒ†ã‚¹ãƒˆãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤
          aws s3 rb "s3://$TEST_BUCKET_NAME" --force 2>/dev/null || true
        else
          echo "   âš ï¸  S3 CreateBucket: May be restricted"
        fi
        
        # DynamoDBæ¨©é™ã®ãƒ†ã‚¹ãƒˆ
        echo ""
        echo "ğŸ” DynamoDB Permissions:"
        echo "   Testing DynamoDB DescribeTable permission..."
        
        # å­˜åœ¨ã—ãªã„ãƒ†ãƒ¼ãƒ–ãƒ«ã§DescribeTableã‚’ãƒ†ã‚¹ãƒˆ
        if aws dynamodb describe-table --table-name "non-existent-table-test" --region $AWS_DEFAULT_REGION 2>&1 | grep -q "ResourceNotFoundException"; then
          echo "   âœ… DynamoDB DescribeTable: OK (ResourceNotFoundException is expected)"
        else
          echo "   âš ï¸  DynamoDB DescribeTable: May have permission issues"
        fi

    - name: Test Terragrunt prerequisites
      run: |
        echo "=== Terragrunt Prerequisites Test ==="
        
        # AWS CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        echo "AWS CLI version:"
        aws --version
        
        echo ""
        echo "AWS configuration:"
        echo "   Default region: $AWS_DEFAULT_REGION"
        echo "   Current region: $(aws configure get region || echo 'Not set')"
        
        echo ""
        echo "Terraform state management readiness:"
        
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        STATE_BUCKET="terraform-state-$ACCOUNT_ID"
        LOCK_TABLE="terraform-state-lock"
        
        echo "   State bucket: $STATE_BUCKET"
        echo "   Lock table: $LOCK_TABLE"
        echo "   Region: $AWS_DEFAULT_REGION"
        
        # å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ç¢ºèª
        echo ""
        echo "Resource availability check:"
        
        if aws s3 ls "s3://$STATE_BUCKET" > /dev/null 2>&1; then
          echo "   âœ… State bucket exists"
        else
          echo "   ğŸ“ State bucket needs to be created"
        fi
        
        if aws dynamodb describe-table --table-name "$LOCK_TABLE" --region $AWS_DEFAULT_REGION > /dev/null 2>&1; then
          echo "   âœ… Lock table exists"
        else
          echo "   ğŸ“ Lock table needs to be created"
        fi

    - name: Generate permissions report
      if: always()
      run: |
        echo "=== Permissions Summary Report ==="
        echo ""
        echo "âœ… Successful operations:"
        echo "   - AWS STS GetCallerIdentity"
        
        # S3ãƒ†ã‚¹ãƒˆçµæœ
        if aws s3 ls > /dev/null 2>&1; then
          echo "   - S3 ListBuckets"
        fi
        
        # DynamoDBãƒ†ã‚¹ãƒˆçµæœ  
        if aws dynamodb list-tables --region $AWS_DEFAULT_REGION > /dev/null 2>&1; then
          echo "   - DynamoDB ListTables"
        fi
        
        echo ""
        echo "ğŸ“‹ Ready for Terragrunt operations:"
        
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        STATE_BUCKET="terraform-state-$ACCOUNT_ID"
        LOCK_TABLE="terraform-state-lock"
        
        # çŠ¶æ…‹ãƒã‚±ãƒƒãƒˆã®ç¢ºèª
        if aws s3 ls "s3://$STATE_BUCKET" > /dev/null 2>&1; then
          echo "   âœ… Terraform state bucket ready"
        else
          echo "   ğŸ“ Run 'make setup-state' to create state bucket"
        fi
        
        # ãƒ­ãƒƒã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç¢ºèª
        if aws dynamodb describe-table --table-name "$LOCK_TABLE" --region $AWS_DEFAULT_REGION > /dev/null 2>&1; then
          echo "   âœ… Terraform lock table ready"
        else
          echo "   ğŸ“ Run 'make setup-state' to create lock table"
        fi
        
        echo ""
        echo "ğŸ¯ Next steps:"
        echo "   1. If all tests passed, your credentials are properly configured"
        echo "   2. Run the main Terragrunt workflow to perform infrastructure operations"
        echo "   3. Check AWS IAM policies if any permissions failed"
        
        echo ""
        echo "ğŸ”— Useful links:"
        echo "   - AWS IAM Console: https://console.aws.amazon.com/iam/"
        echo "   - AWS S3 Console: https://console.aws.amazon.com/s3/"
        echo "   - AWS DynamoDB Console: https://console.aws.amazon.com/dynamodb/"
