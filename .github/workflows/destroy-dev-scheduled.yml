name: Destroy Dev Environment (Scheduled)

on:
  schedule:
    # æ¯æ—¥18æ™‚ï¼ˆJSTï¼‰= æ—¥æœ¬æ™‚é–“18æ™‚ã«devç’°å¢ƒã‚’å‰Šé™¤
    - cron: '0 9 * * *'  # UTC 09:00 (JST 18:00)
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      target:
        description: 'Target module to destroy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - s3

env:
  AWS_DEFAULT_REGION: ap-northeast-1
  TF_INPUT: false
  TF_IN_AUTOMATION: true

jobs:
  destroy-dev:
    name: Destroy Dev Environment
    runs-on: ubuntu-latest
    # environment: development  # å¿…è¦ã«å¿œã˜ã¦GitHubç’°å¢ƒä¿è­·ã‚’è¨­å®š
    defaults:
      run:
        working-directory: terragrunt

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ~1.6.0

    - name: Setup Terragrunt
      run: |
        wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v0.82.3/terragrunt_linux_amd64
        chmod +x terragrunt_linux_amd64
        sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt
        terragrunt --version

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_DEFAULT_REGION }}

    - name: Check resources before destroy
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        echo "=== å‰Šé™¤å‰ã®ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="
        make status || echo "ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

    - name: Destroy dev environment
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        echo "=== Devç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ä¸­ ==="
        make dev-destroy

    - name: Verify destruction
      run: |
        export target=${{ github.event.inputs.target || 'all' }}
        echo "=== å‰Šé™¤å¾Œã®ç¢ºèª ==="
        make status || echo "æ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸ"

    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ğŸš¨ Devç’°å¢ƒã®å®šæœŸå‰Šé™¤ãŒå¤±æ•—ã—ã¾ã—ãŸ';
          const body = `
          **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
          **å¯¾è±¡**: ${{ github.event.inputs.target || 'all' }}
          **ãƒ­ã‚°**: [å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          æ‰‹å‹•ã§ç¢ºèªã¨å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
          `;
          
          // Issueä½œæˆï¼ˆé€šçŸ¥ç”¨ï¼‰
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['infrastructure', 'urgent']
          });
